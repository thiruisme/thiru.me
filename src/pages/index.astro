---
import Layout from "../components/Layout.astro";
import { getCollection } from "astro:content";


const posts = await getCollection("posts");

// Build tag frequency map
const tagMap = new Map<string, typeof posts>();
for (const post of posts) {
  if (post.data.tags) {
    for (const tag of post.data.tags) {
      if (!tagMap.has(tag)) tagMap.set(tag, []);
      tagMap.get(tag)!.push(post);
    }
  }
}

// Derive top-10 popular tags
const popularTags = Array.from(tagMap.entries())
  .sort(([, a], [, b]) => b.length - a.length)
  .map(([tag]) => tag)
  .slice(0, 10);
---
<Layout current="home" hero={true} title="GBA • Emerald Fan Blog">
  <div class="home-grid">

    <!-- MAIN COLUMN -->
    <main class="content">
      <h1>Latest Posts</h1>

      <section class="cards">
        {posts
          .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
          .slice(0, 4)
          .map((p) => (
            <article class="card">
              <a href={`/blog/${p.slug}/`}>
                <img
                  src={p.data.thumbnail ?? "https://placehold.co/280x160?text=Thumbnail"}
                  alt={p.data.title}
                />
                <div class="card-body">
                  <div class="card-title">{p.data.title}</div>
                  <p class="card-text">{p.data.excerpt}</p>
                </div>
              </a>
            </article>
          ))}
      </section>

      <section>
        <h2>Quick Facts</h2>
        <p>
          The GBA sold over <strong>80 million</strong> units worldwide.
          The SP’s back-light dropped in 2003!
        </p>
      </section>

      <section>
        <h2>Popular Tags</h2>
        <div class="tags">
          {popularTags.map((tag) => (
            <a class="tag-pill" href={`/tags/${tag}/`}>{tag}</a>
          ))}
        </div>
      </section>
    </main>

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <section>
        <h2>Tip of the Day</h2>
        <p>
          In Pokémon Emerald, using&nbsp;<strong>Rain Dance</strong> plus
          <em>Swift Swim</em> can make Ludicolo faster than almost any other
          Pokémon!
        </p>
      </section>

      <section>
        <h2><a href="/tags">Browse Tags</a></h2>
      </section>

      <section>
        <h2>Random Pokémon</h2>
        <img
          src="https://placehold.co/200x200?text=Pokémon"
          alt="Random Pokémon"
          class="sidebar-image"
        />
      </section>
    </aside>

  </div>
</Layout>